import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Settings, X, Lock, Unlock, Zap, Gauge, Info } from 'lucide-react';

const Card = ({ children, className = "" }) => (
  <div className={`bg-slate-900/50 backdrop-blur-xl border border-white/10 rounded-3xl p-6 shadow-2xl ${className}`}>
    {children}
  </div>
);

const Button = ({ onClick, active, children, icon: Icon }) => (
  <button
    onClick={onClick}
    className={`flex items-center gap-2 px-4 py-2 rounded-full font-medium transition-all duration-300 ${
      active 
        ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/30' 
        : 'bg-white/10 text-white/70 hover:bg-white/20'
    }`}
  >
    {Icon && <Icon size={18} />}
    {children}
  </button>
);

export default function TwingoDash() {
  // --- STATE ---
  const [speed, setSpeed] = useState(0);
  const [rpm, setRpm] = useState(0);
  const [currentGear, setCurrentGear] = useState(1);
  const [gpsActive, setGpsActive] = useState(false);
  const [wakeLock, setWakeLock] = useState(null);
  const [showSettings, setShowSettings] = useState(false);
  
  // Valeurs par défaut Twingo (km/h pour 1000 tr/min)
  const defaultRatios = { 1: 7.45, 2: 13.45, 3: 18.97, 4: 24.35, 5: 30.55, 6: 36.08 };
  
  const [ratios, setRatios] = useState(defaultRatios);
  const [minRpm, setMinRpm] = useState(1500);
  const [maxRpm, setMaxRpm] = useState(3000);

  // --- LOCAL STORAGE ---
  useEffect(() => {
    // Chargement au démarrage
    const savedRatios = localStorage.getItem('twingo_ratios');
    if (savedRatios) setRatios(JSON.parse(savedRatios));
  }, []);

  useEffect(() => {
    // Sauvegarde à chaque changement
    localStorage.setItem('twingo_ratios', JSON.stringify(ratios));
  }, [ratios]);

  // --- LOGIC ---
  const determineGear = useCallback((currentSpeed) => {
    if (currentSpeed < 5) return 1; // Au repos ou très lent

    let bestGear = 1;
    let bestScore = Infinity;

    for (let g = 1; g <= 6; g++) {
      const calculatedRpm = (currentSpeed * 1000) / ratios[g];
      
      // Si dans la plage idéale, c'est le candidat parfait
      if (calculatedRpm >= minRpm && calculatedRpm <= maxRpm) return g;

      // Sinon on cherche le rapport qui nous rapproche le plus de la plage
      const score = Math.min(
        Math.abs(calculatedRpm - minRpm),
        Math.abs(calculatedRpm - maxRpm)
      );

      if (score < bestScore) {
        bestScore = score;
        bestGear = g;
      }
    }
    return bestGear;
  }, [ratios, minRpm, maxRpm]);

  // --- GPS LOOP ---
  useEffect(() => {
    if (!navigator.geolocation) return;

    const watchId = navigator.geolocation.watchPosition(
      (pos) => {
        setGpsActive(true);
        let speedMs = pos.coords.speed; // Vitesse en m/s
        
        // Parfois le GPS renvoie null si immobile
        if (speedMs === null || speedMs < 0) speedMs = 0;
        
        const speedKmh = speedMs * 3.6;
        setSpeed(speedKmh);

        const gear = determineGear(speedKmh);
        setCurrentGear(gear);
        
        const calculatedRpm = (speedKmh * 1000) / ratios[gear];
        setRpm(Math.round(calculatedRpm));
      },
      (err) => {
        console.error("GPS Error", err);
        setGpsActive(false);
      },
      { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 }
    );

    return () => navigator.geolocation.clearWatch(watchId);
  }, [ratios, determineGear]);

  // --- WAKE LOCK (Anti-Veille) ---
  const toggleWakeLock = async () => {
    if (wakeLock) {
      await wakeLock.release();
      setWakeLock(null);
    } else {
      try {
        const lock = await navigator.wakeLock.request('screen');
        setWakeLock(lock);
        // Le lock peut être relâché par le système (ex: changement d'app)
        lock.addEventListener('release', () => {
          setWakeLock(null);
        });
      } catch (err) {
        console.error(`Wake Lock error: ${err.name}, ${err.message}`);
      }
    }
  };

  // --- RENDER HELPERS ---
  const getRpmColor = (val) => {
    if (val < 2000) return 'text-emerald-400';
    if (val < 3500) return 'text-blue-400';
    if (val < 5000) return 'text-orange-400';
    return 'text-red-500 animate-pulse';
  };

  const getProgress = (val, max) => Math.min((val / max) * 100, 100);

  return (
    <div className="min-h-screen bg-black text-white font-sans selection:bg-blue-500/30 pb-10">
      
      {/* Background Ambience */}
      <div className="fixed inset-0 pointer-events-none overflow-hidden">
        <div className="absolute -top-[20%] -left-[10%] w-[500px] h-[500px] bg-blue-600/20 rounded-full blur-[120px]" />
        <div className="absolute bottom-[10%] -right-[10%] w-[400px] h-[400px] bg-purple-600/20 rounded-full blur-[100px]" />
      </div>

      {/* Header */}
      <header className="relative z-10 flex justify-between items-center p-6">
        <div className="flex items-center gap-2">
          <div className={`w-3 h-3 rounded-full ${gpsActive ? 'bg-green-500 shadow-[0_0_10px_#22c55e]' : 'bg-red-500'}`} />
          <span className="text-sm font-medium tracking-wide text-slate-400">
            {gpsActive ? 'GPS CONNECTÉ' : 'RECHERCHE GPS...'}
          </span>
        </div>
        <button 
          onClick={() => setShowSettings(true)}
          className="p-2 bg-white/5 hover:bg-white/10 rounded-full transition-colors"
        >
          <Settings size={20} className="text-slate-300" />
        </button>
      </header>

      <main className="relative z-10 px-6 max-w-md mx-auto space-y-6">
        
        {/* Main Display: RPM */}
        <div className="text-center py-8">
          <div className="relative inline-flex flex-col items-center justify-center w-64 h-64">
            {/* RPM Circle Track */}
            <svg className="absolute w-full h-full transform -rotate-90">
              <circle cx="128" cy="128" r="120" stroke="currentColor" strokeWidth="12" fill="transparent" className="text-slate-800" />
              <circle 
                cx="128" cy="128" r="120" stroke="currentColor" strokeWidth="12" fill="transparent"
                className={`${getRpmColor(rpm)} transition-all duration-500 ease-out`}
                strokeDasharray={2 * Math.PI * 120}
                strokeDashoffset={2 * Math.PI * 120 - (2 * Math.PI * 120 * getProgress(rpm, 7000)) / 100}
                strokeLinecap="round"
              />
            </svg>
            
            <div className="flex flex-col items-center z-10">
              <span className={`text-6xl font-bold tracking-tighter ${getRpmColor(rpm)} tabular-nums`}>
                {rpm}
              </span>
              <span className="text-slate-400 text-sm font-medium mt-1">tr/min</span>
            </div>
          </div>
        </div>

        {/* Gear & Speed Grid */}
        <div className="grid grid-cols-2 gap-4">
          <Card className="flex flex-col items-center justify-center h-40">
            <span className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Rapport</span>
            <div className="text-7xl font-bold text-white tabular-nums">
              {currentGear}
            </div>
            <div className="text-xs text-blue-400 mt-1 font-medium">ESTIMÉ</div>
          </Card>

          <Card className="flex flex-col items-center justify-center h-40 relative overflow-hidden">
            <div className="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent" />
            <span className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Vitesse</span>
            <div className="text-5xl font-bold text-white tabular-nums">
              {Math.round(speed)}
            </div>
            <div className="text-sm text-slate-400 font-medium">km/h</div>
          </Card>
        </div>

        {/* Actions */}
        <div className="flex justify-center pt-4">
          <Button 
            onClick={toggleWakeLock} 
            active={!!wakeLock}
            icon={!!wakeLock ? Lock : Unlock}
          >
            {!!wakeLock ? 'Mode Conduite (Écran actif)' : 'Mode Conduite (Désactivé)'}
          </Button>
        </div>

        {/* Disclaimer */}
        <p className="text-xs text-slate-600 text-center px-8">
          Gardez les yeux sur la route. Valeurs estimées basées sur le GPS.
        </p>
      </main>

      {/* Settings Modal */}
      {showSettings && (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200">
          <div className="bg-slate-900 border border-white/10 w-full max-w-md rounded-3xl overflow-hidden shadow-2xl animate-in slide-in-from-bottom-10 duration-300">
            
            <div className="flex justify-between items-center p-6 border-b border-white/5">
              <h2 className="text-xl font-bold text-white">Garage</h2>
              <button onClick={() => setShowSettings(false)} className="p-2 bg-white/5 rounded-full hover:bg-white/10">
                <X size={20} className="text-white" />
              </button>
            </div>

            <div className="p-6 space-y-6 max-h-[60vh] overflow-y-auto">
              
              <div className="space-y-4">
                <div className="flex items-center gap-2 text-blue-400 mb-2">
                  <Gauge size={18} />
                  <span className="font-bold text-sm uppercase tracking-wider">Rapports de Boîte</span>
                </div>
                <p className="text-xs text-slate-400 mb-4">
                  Vitesse en km/h pour 1000 tr/min. Ces valeurs sont sauvegardées automatiquement.
                </p>

                <div className="grid grid-cols-2 gap-4">
                  {[1, 2, 3, 4, 5, 6].map(g => (
                    <div key={g} className="space-y-1">
                      <label className="text-xs text-slate-500 font-medium ml-1">Rapport {g}</label>
                      <input
                        type="number"
                        step="0.01"
                        value={ratios[g]}
                        onChange={(e) => setRatios({...ratios, [g]: parseFloat(e.target.value) || 0})}
                        className="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all"
                      />
                    </div>
                  ))}
                </div>
              </div>

              <div className="pt-4 border-t border-white/5">
                <button 
                  onClick={() => setRatios(defaultRatios)}
                  className="w-full py-3 text-sm text-red-400 hover:text-red-300 font-medium transition-colors"
                >
                  Réinitialiser aux valeurs Twingo
                </button>
              </div>
            </div>

          </div>
        </div>
      )}

    </div>
  );
}

